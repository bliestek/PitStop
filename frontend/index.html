<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PitStop - Vehicle Maintenance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{ --bg1:#0f172a; --bg2:#1e293b; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#3b82f6; --brand-2:#1d4ed8; --success:#10b981; --warn:#f59e0b; --danger:#ef4444; --radius:14px; }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100svh;color:#111;}
    .header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.95);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #e5e7eb;}
    .header-content{max-width:1200px;margin:auto;display:flex;gap:12px;align-items:center;padding:10px 16px}
    .logo{font-weight:700;font-size:clamp(18px,3.5vw,24px)} .spacer{flex:1}
    .nav{display:flex;gap:8px} .nav-btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.2s;touch-action:manipulation;}
    .nav-btn:hover{background:var(--brand-2);transform:translateY(-1px)} .nav-btn.active{background:#1e40af}
    .hamburger{display:none;background:#e5e7eb;border:0;border-radius:10px;padding:8px 10px}
    .mobile-nav{display:none;flex-direction:column;gap:8px;padding:8px}
    .container{max-width:1200px;margin:auto;padding:16px}
    .content-section{display:none} .content-section.active{display:block}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:0 10px 30px rgba(2,6,23,.15)}
    .stats-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));}
    .stat-card{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-radius:12px;padding:18px;text-align:center;cursor:pointer;transition:.2s}
    .stat-card:hover{transform:translateY(-3px)} .stat-card h3{font-size:clamp(22px,4vw,36px);margin:.15em 0}
    .vehicles-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
    .vehicle-card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .vehicle-header{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px}
    .vehicle-title{font-weight:700} .vehicle-actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;transition:.2s}
    .btn:active{transform:translateY(1px)} .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-2)}
    .btn-success{background:var(--success);color:#fff} .btn-danger{background:var(--danger);color:#fff}
    .btn-secondary{background:#6b7280;color:#fff} .btn-warning{background:var(--warn);color:#fff}
    .btn-sm{padding:6px 10px;font-size:.9rem} .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .form-group{margin-bottom:12px} .form-label{display:block;font-weight:600;margin:0 0 6px}
    .form-input,.form-select,textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px}
    .form-input:focus,.form-select:focus,textarea:focus{outline:none;border-color:var(--brand)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
    .modal.active{display:flex} .modal-content{background:#fff;border-radius:16px;padding:16px;max-width:900px;width:min(900px,100%);max-height:85svh;overflow:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .tabbar{display:flex;gap:10px;border-bottom:2px solid #e5e7eb;margin-bottom:12px;overflow:auto}
    .tab{padding:10px 14px;border:0;background:none;font-weight:700;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    .record-item{background:#f8fafc;border-left:4px solid var(--brand);border-radius:10px;padding:12px;margin:8px 0;position:relative}
    .record-actions{position:absolute;top:10px;right:10px;display:flex;gap:6px}
    .record-type{background:var(--brand);color:#fff;border-radius:6px;padding:4px 8px;font-size:.8rem}
    .record-date{color:#6b7280;font-size:.9rem}
    .next-service{background:#fef3c7;border:1px solid #f59e0b;border-radius:10px;padding:8px;margin-top:8px;font-size:.9rem}
    .next-service.overdue{background:#fee2e2;border-color:#ef4444}
    .next-service.due-soon{background:#dbeafe;border-color:#3b82f6}
    .hidden{display:none!important}
    .api-info{background:#eff6ff;border:1px solid #93c5fd;border-radius:10px;padding:10px;margin:12px 0;font-size:.95rem}
    .debug-info{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.85rem;max-height:260px;overflow:auto}
    @media (max-width: 768px){ .grid-2{grid-template-columns:1fr} .nav{display:none} .hamburger{display:inline-flex} .mobile-nav.show{display:flex} .vehicle-actions .btn{flex:1} .modal-content{padding:12px;border-radius:14px} }
  </style>
</head>
<body>
<header class="header">
  <div class="header-content">
    <div class="logo">üöó PitStop</div>
    <div class="spacer"></div>
    <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
    <nav class="nav" id="desktopNav">
      <button class="nav-btn active" data-nav="dashboard">Dashboard</button>
      <button class="nav-btn" data-nav="vehicles">Vehicles</button>
      <button class="nav-btn" data-nav="maintenance">Maintenance</button>
      <button class="nav-btn" data-nav="reports">Reports</button>
    </nav>
  </div>
  <nav class="mobile-nav" id="mobileNav">
    <button class="nav-btn active" data-nav="dashboard">Dashboard</button>
    <button class="nav-btn" data-nav="vehicles">Vehicles</button>
    <button class="nav-btn" data-nav="maintenance">Maintenance</button>
    <button class="nav-btn" data-nav="reports">Reports</button>
  </nav>
</header>

<main class="container">
  <section id="dashboard" class="content-section active">
    <div class="card">
      <h2>Dashboard Overview</h2>
      <div class="api-info">
        <strong>API:</strong> <span id="api-url-display">/api</span> ‚Äî <strong>Status:</strong> <span id="api-status">Checking‚Ä¶</span><br/>
        <strong>Current URL:</strong> <span id="current-location"></span>
      </div>
      <div class="debug-info" id="debug-log"><strong>Debug:</strong><br/></div>
      <div id="stats-loading">Loading dashboard stats‚Ä¶</div>
      <div id="stats-grid" class="stats-grid hidden">
        <div class="stat-card" data-nav="vehicles"><h3 id="total-vehicles">0</h3><p>üöó Vehicles</p></div>
        <div class="stat-card" data-nav="maintenance"><h3 id="total-maintenance">0</h3><p>üîß Maintenance</p></div>
        <div class="stat-card" data-nav="reports"><h3 id="total-insurance">0</h3><p>üõ°Ô∏è Insurance</p></div>
        <div class="stat-card" data-nav="reports"><h3 id="total-registration">0</h3><p>üìã Registration</p></div>
      </div>
    </div>
  </section>

  <section id="vehicles" class="content-section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
        <h2>My Vehicles</h2>
        <button class="btn btn-primary" onclick="openAddVehicleModal()">+ Add Vehicle</button>
      </div>
      <div id="vehicles-loading">Loading vehicles‚Ä¶</div>
      <div id="vehicles-grid" class="vehicles-grid"></div>
    </div>
  </section>

  <section id="maintenance" class="content-section">
    <div class="card">
      <h2>All Maintenance Records</h2>
      <div id="all-maintenance-records"></div>
    </div>
  </section>

  <section id="reports" class="content-section">
    <div class="card">
      <h2>Reports & Analytics</h2>
      <div class="stats-grid">
        <div class="stat-card"><h3 id="report-vehicles">0</h3><p>üöó Total Vehicles</p></div>
        <div class="stat-card"><h3 id="report-maintenance">0</h3><p>üîß Total Maintenance</p></div>
        <div class="stat-card"><h3 id="report-cost">$0</h3><p>üí∞ Total Spent</p></div>
        <div class="stat-card"><h3 id="report-avg">$0</h3><p>üìä Avg/Vehicle</p></div>
      </div>
      <div>
        <h3>Upcoming Services</h3>
        <div id="upcoming-services"></div>
      </div>
    </div>
  </section>
</main>

<!-- Modals (Vehicle, Maintenance, Insurance, Registration) -->
<div id="vehicleModal" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 id="vehicleModalTitle">Add New Vehicle</h3><button class="btn btn-secondary btn-sm" onclick="closeModal('vehicleModal')">Close</button></div>
  <form id="vehicleForm">
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Make</label><input class="form-input" name="make" required></div>
      <div class="form-group"><label class="form-label">Model</label><input class="form-input" name="model" required></div>
      <div class="form-group"><label class="form-label">Year</label><input class="form-input" type="number" name="year" required min="1900" max="2100"></div>
      <div class="form-group"><label class="form-label">Color</label><input class="form-input" name="color" required></div>
    </div>
    <div class="form-group"><label class="form-label">VIN</label><input class="form-input" name="vin" required maxlength="17"></div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">License Plate</label><input class="form-input" name="license_plate" required></div>
      <div class="form-group"><label class="form-label">Mileage (km)</label><input class="form-input" type="number" name="mileage" min="0" required></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button type="button" class="btn btn-secondary" onclick="closeModal('vehicleModal')">Cancel</button>
      <button type="submit" class="btn btn-primary">Save Vehicle</button>
    </div>
  </form>
</div></div>

<div id="vehicleDetailsModal" class="modal"><div class="modal-content" style="max-width:900px">
  <div class="modal-header"><h3 id="vehicleDetailsTitle">Vehicle Details</h3><button class="btn btn-secondary btn-sm" onclick="closeModal('vehicleDetailsModal')">Close</button></div>
  <div id="vehicleDetailsContent"></div>
</div></div>

<div id="maintenanceModal" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 id="maintenanceModalTitle">Add Maintenance Record</h3><button class="btn btn-secondary btn-sm" onclick="closeModal('maintenanceModal')">Close</button></div>
  <form id="maintenanceForm">
    <input type="hidden" name="vehicle_id" id="maintenanceVehicleId">
    <input type="hidden" name="maintenance_id" id="maintenanceRecordId">
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select name="type" class="form-select" required>
          <option value="oil_change">Oil Change</option>
          <option value="tire_rotation">Tire Rotation</option>
          <option value="brake_service">Brake Service</option>
          <option value="transmission_service">Transmission Service</option>
          <option value="air_filter_replacement">Air Filter Replacement</option>
          <option value="spark_plug_replacement">Spark Plug Replacement</option>
          <option value="battery_replacement">Battery Replacement</option>
          <option value="coolant_flush">Coolant Flush</option>
          <option value="tune_up">Tune Up</option>
          <option value="inspection">Inspection</option>
          <option value="repair">Repair</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" name="date" required></div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><input class="form-input" name="description" required></div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Mileage (km)</label><input class="form-input" type="number" name="mileage" min="0" required></div>
      <div class="form-group"><label class="form-label">Cost</label><input class="form-input" type="number" name="cost" step="0.01" min="0" required></div>
    </div>
    <div class="form-group"><label class="form-label">Service Provider</label><input class="form-input" name="service_provider" required></div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Next Service Date</label><input class="form-input" type="date" name="next_due_date"></div>
      <div class="form-group"><label class="form-label">Next Service km</label><input class="form-input" type="number" name="next_due_mileage" min="0"></div>
    </div>
    <div class="form-group"><label class="form-label">Notes</label><textarea name="notes" rows="3"></textarea></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button type="button" class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancel</button>
      <button type="submit" class="btn btn-primary" id="maintenanceSubmitBtn">Save Record</button>
    </div>
  </form>
</div></div>

<div id="insuranceModal" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 id="insuranceModalTitle">Add Insurance</h3><button class="btn btn-secondary btn-sm" onclick="closeModal('insuranceModal')">Close</button></div>
  <form id="insuranceForm">
    <input type="hidden" name="vehicle_id" id="insuranceVehicleId">
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Provider</label><input class="form-input" name="provider" required></div>
      <div class="form-group"><label class="form-label">Policy #</label><input class="form-input" name="policy_number" required></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Start</label><input class="form-input" type="date" name="start_date" required></div>
      <div class="form-group"><label class="form-label">End</label><input class="form-input" type="date" name="end_date" required></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Premium</label><input class="form-input" type="number" name="premium" step="0.01" min="0" required></div>
      <div class="form-group"><label class="form-label">Deductible</label><input class="form-input" type="number" name="deductible" step="0.01" min="0" required></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Coverage</label><input class="form-input" name="coverage_type" placeholder="Comprehensive / Third-party‚Ä¶"></div>
      <div class="form-group"><label class="form-label">Notes</label><input class="form-input" name="notes"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button type="button" class="btn btn-secondary" onclick="closeModal('insuranceModal')">Cancel</button>
      <button type="submit" class="btn btn-primary">Save</button>
    </div>
  </form>
</div></div>

<div id="registrationModal" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 id="registrationModalTitle">Add Registration</h3><button class="btn btn-secondary btn-sm" onclick="closeModal('registrationModal')">Close</button></div>
  <form id="registrationForm">
    <input type="hidden" name="vehicle_id" id="registrationVehicleId">
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Registration #</label><input class="form-input" name="registration_number" required></div>
      <div class="form-group"><label class="form-label">State</label><input class="form-input" name="state" required></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Issue Date</label><input class="form-input" type="date" name="issue_date" required></div>
      <div class="form-group"><label class="form-label">Expiry Date</label><input class="form-input" type="date" name="expiry_date" required></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label class="form-label">Fee</label><input class="form-input" type="number" name="fee" step="0.01" min="0" required></div>
      <div class="form-group"><label class="form-label">Notes</label><input class="form-input" name="notes"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">Cancel</button>
      <button type="submit" class="btn btn-primary">Save</button>
    </div>
  </form>
</div></div>

<script>
// --- Utilities ---
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const debug = (m)=>{ const e=$("#debug-log"); const t=new Date().toLocaleTimeString(); e.innerHTML += t+": "+m+"<br/>"; e.scrollTop=e.scrollHeight; console.log("[PitStop]", m); };

// API base: always /api via nginx
const API_BASE = "/api";
$("#current-location").textContent = location.href;

// Nav
function showSection(name){
  $$(".content-section").forEach(s=>s.classList.remove("active"));
  $("#"+name).classList.add("active");
  $$("[data-nav]").forEach(b=>b.classList.remove("active"));
  $$(`[data-nav="${name}"]`).forEach(b=>b.classList.add("active"));
  if(name==="vehicles") loadVehicles();
  if(name==="maintenance") loadAllMaintenance();
  if(name==="reports") loadReports();
}
$$("[data-nav]").forEach(btn=>btn.addEventListener("click",()=>showSection(btn.dataset.nav)));
$("#hamburger").addEventListener("click",()=>$("#mobileNav").classList.toggle("show"));

// Modals
function openModal(id){ $("#"+id).classList.add("active"); }
function closeModal(id){ $("#"+id).classList.remove("active"); }

// Fetch wrapper
async function api(path, options={}){
  const url = API_BASE + path; // single /api prefix
  debug("fetch "+url);
  const res = await fetch(url, {headers:{'Content-Type':'application/json'}, ...options});
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äì ${t}`);
  }
  $("#api-status").textContent = "‚úÖ Connected";
  return res.json();
}

// Health & dashboard
async function init(){
  try { await api("/health"); } 
  catch(e){ $("#api-status").textContent="‚ùå API error"; debug(e.message); }
  await loadDashboard();
  const today = new Date().toISOString().split('T')[0];
  $('#maintenanceForm [name="date"]').value = today;
}

async function loadDashboard(){
  try{
    const s = await api("/dashboard/stats");
    $("#total-vehicles").textContent = s.total_vehicles;
    $("#total-maintenance").textContent = s.total_maintenance_records;
    $("#total-insurance").textContent = s.total_insurance_records;
    $("#total-registration").textContent = s.total_registration_records;
    $("#stats-loading").classList.add("hidden");
    $("#stats-grid").classList.remove("hidden");
  }catch(e){
    $("#stats-loading").textContent = "Failed: "+e.message;
  }
}

// Vehicles
let vehicles = [], currentVehicle=null;
async function loadVehicles(){
  $("#vehicles-loading").classList.remove("hidden");
  $("#vehicles-grid").innerHTML = "";
  try{
    vehicles = await api("/vehicles");
    $("#vehicles-loading").classList.add("hidden");
    if(!vehicles.length){
      $("#vehicles-grid").innerHTML = '<div class="card">No vehicles yet. Use ‚ÄúAdd Vehicle‚Äù.</div>';
      return;
    }
    $("#vehicles-grid").innerHTML = vehicles.map(v=>`
      <div class="vehicle-card">
        <div class="vehicle-header">
          <div class="vehicle-title">${v.year} ${v.make} ${v.model}</div>
          <div class="vehicle-actions">
            <button class="btn btn-primary btn-sm" onclick="viewVehicleDetails('${v.id}')">Details</button>
            <button class="btn btn-danger btn-sm" onclick="deleteVehicle('${v.id}')">Delete</button>
          </div>
        </div>
        <div class="grid-2" style="color:#6b7280;font-size:.95rem">
          <div><strong>License:</strong> ${v.license_plate}</div>
          <div><strong>Color:</strong> ${v.color}</div>
          <div><strong>Mileage:</strong> ${parseInt(v.mileage).toLocaleString()} km</div>
          <div><strong>VIN:</strong> ${v.vin.slice(-4)}</div>
        </div>
      </div>
    `).join("");
  }catch(e){
    $("#vehicles-loading").textContent = "Error: "+e.message;
  }
}

function openAddVehicleModal(){
  $("#vehicleModalTitle").textContent = "Add New Vehicle";
  $("#vehicleForm").reset();
  $("#vehicleForm").removeAttribute("data-vehicle-id");
  openModal("vehicleModal");
}

async function viewVehicleDetails(id){
  try{
    const v = await api(`/vehicles/${id}`);
    const m = await api(`/vehicles/${id}/maintenance`);
    const i = await api(`/vehicles/${id}/insurance`);
    const r = await api(`/vehicles/${id}/registration`);
    currentVehicle = v;
    renderVehicleDetails(v,m,i,r);
    openModal("vehicleDetailsModal");
  }catch(e){ alert("Failed to load details: "+e.message); }
}

function nextServiceBadge(rec){
  if(!rec.next_due_date && !rec.next_due_mileage) return "";
  let cls="next-service", txt="Next service: ";
  if(rec.next_due_date){
    const due = new Date(rec.next_due_date), today=new Date();
    const days = Math.ceil((due-today)/86400000);
    if(days<0){ cls += " overdue"; txt += `OVERDUE (${Math.abs(days)} days ago)`; }
    else if(days<=30){ cls += " due-soon"; txt += `Due in ${days} days`; }
    else txt += due.toLocaleDateString();
  }
  if(rec.next_due_mileage){
    if(rec.next_due_date) txt+=" or ";
    txt += `${parseInt(rec.next_due_mileage).toLocaleString()} km`;
  }
  return `<div class="${cls}">${txt}</div>`;
}

function renderVehicleDetails(v, maint, ins, reg){
  $("#vehicleDetailsTitle").textContent = `${v.year} ${v.make} ${v.model}`;
  const el = $("#vehicleDetailsContent");
  el.innerHTML = `
    <div class="tabbar">
      <button class="tab active" data-tab="info">Vehicle Info</button>
      <button class="tab" data-tab="maintenance">Maintenance (${maint.length})</button>
      <button class="tab" data-tab="insurance">Insurance (${ins.length})</button>
      <button class="tab" data-tab="registration">Registration (${reg.length})</button>
    </div>
    <div id="tab-info" class="tab-pane">
      <div class="grid-2">
        <div><strong>Make:</strong> ${v.make}</div>
        <div><strong>Model:</strong> ${v.model}</div>
        <div><strong>Year:</strong> ${v.year}</div>
        <div><strong>Color:</strong> ${v.color}</div>
        <div><strong>Plate:</strong> ${v.license_plate}</div>
        <div><strong>Mileage:</strong> ${parseInt(v.mileage).toLocaleString()} km</div>
        <div style="grid-column:1/-1"><strong>VIN:</strong> ${v.vin}</div>
      </div>
    </div>
    <div id="tab-maintenance" class="tab-pane hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
        <h4>Maintenance</h4>
        <button class="btn btn-success" onclick="openMaintenanceModal('${v.id}')">+ Add Maintenance</button>
      </div>
      <div>
        ${maint.length? maint.map(r=>`
          <div class="record-item">
            <div class="record-actions">
              <button class="btn btn-warning btn-sm" onclick="editMaintenanceRecord('${r.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteMaintenanceRecord('${r.id}')">Delete</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="record-type">${(r.type||'').replace('_',' ').toUpperCase()}</span>
              <span class="record-date">${new Date(r.date).toLocaleDateString()}</span>
            </div>
            <div><strong>${r.description}</strong></div>
            <div style="margin-top:6px;color:#6b7280;font-size:.95rem">
              ${r.service_provider} ‚Ä¢ ${parseInt(r.mileage).toLocaleString()} km ‚Ä¢ $${parseFloat(r.cost).toFixed(2)}
            </div>
            ${r.notes? `<div style="margin-top:6px;font-style:italic">${r.notes}</div>`:''}
            ${nextServiceBadge(r)}
          </div>
        `).join("") : '<div class="card">No maintenance yet.</div>'}
      </div>
    </div>
    <div id="tab-insurance" class="tab-pane hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
        <h4>Insurance</h4>
        <button class="btn btn-success" onclick="openInsuranceModal('${v.id}')">+ Add Insurance</button>
      </div>
      <div>
        ${ins.length? ins.map(r=>`
          <div class="record-item">
            <div><strong>${r.provider}</strong> ‚Äî ${r.coverage_type||''}</div>
            <div style="margin-top:6px;color:#6b7280;font-size:.95rem">
              Policy ${r.policy_number} ‚Ä¢ Premium $${parseFloat(r.premium).toFixed(2)} ‚Ä¢ Deductible $${parseFloat(r.deductible).toFixed(2)}
            </div>
            <div style="margin-top:4px;color:#6b7280;font-size:.95rem">
              ${new Date(r.start_date).toLocaleDateString()} ‚Äì ${new Date(r.end_date).toLocaleDateString()}
            </div>
          </div>
        `).join("") : '<div class="card">No insurance records yet.</div>'}
      </div>
    </div>
    <div id="tab-registration" class="tab-pane hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
        <h4>Registration</h4>
        <button class="btn btn-success" onclick="openRegistrationModal('${v.id}')">+ Add Registration</button>
      </div>
      <div>
        ${reg.length? reg.map(r=>`
          <div class="record-item">
            <div><strong>Reg #${r.registration_number}</strong> ‚Äî ${r.state}</div>
            <div style="margin-top:6px;color:#6b7280;font-size:.95rem">
              Issued ${new Date(r.issue_date).toLocaleDateString()} ‚Ä¢ Expires ${new Date(r.expiry_date).toLocaleDateString()}
            </div>
            <div style="margin-top:4px;color:#6b7280;font-size:.95rem">Fee $${parseFloat(r.fee).toFixed(2)}</div>
          </div>
        `).join("") : '<div class="card">No registration records yet.</div>'}
      </div>
    </div>
  `;
  $$(".tabbar .tab", el).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tabbar .tab", el).forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      $$(".tab-pane", el).forEach(p=>p.classList.add("hidden"));
      $("#tab-"+btn.dataset.tab, el).classList.remove("hidden");
    });
  });
}

async function deleteVehicle(id){
  if(!confirm("Delete vehicle and all related records?")) return;
  await api(`/vehicles/${id}`, {method:"DELETE"});
  await loadVehicles();
  await loadDashboard();
  alert("Vehicle deleted.");
}

// Maintenance modal
function openMaintenanceModal(vehicleId){
  $("#maintenanceModalTitle").textContent = "Add Maintenance Record";
  $("#maintenanceSubmitBtn").textContent = "Save Record";
  $("#maintenanceForm").reset();
  $("#maintenanceVehicleId").value = vehicleId;
  $("#maintenanceRecordId").value = "";
  $('#maintenanceForm [name="date"]').value = new Date().toISOString().split('T')[0];
  openModal("maintenanceModal");
}
async function editMaintenanceRecord(id){
  const r = await api(`/maintenance/${id}`);
  $("#maintenanceModalTitle").textContent = "Edit Maintenance Record";
  $("#maintenanceSubmitBtn").textContent = "Update Record";
  $("#maintenanceVehicleId").value = r.vehicle_id;
  $("#maintenanceRecordId").value = id;
  for (const [k,v] of Object.entries(r)){
    const f = $(`#maintenanceForm [name="${k}"]`);
    if(!f) continue;
    f.value = v ?? "";
  }
  openModal("maintenanceModal");
}
async function deleteMaintenanceRecord(id){
  if(!confirm("Delete maintenance record?")) return;
  await api(`/maintenance/${id}`, {method:"DELETE"});
  await loadDashboard();
  if(currentVehicle) viewVehicleDetails(currentVehicle.id);
  if($("#maintenance").classList.contains("active")) loadAllMaintenance();
  alert("Maintenance deleted.");
}

// Insurance modal
function openInsuranceModal(vehicleId){ $("#insuranceForm").reset(); $("#insuranceVehicleId").value = vehicleId; openModal("insuranceModal"); }
$("#insuranceForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  data.premium = parseFloat(data.premium);
  data.deductible = parseFloat(data.deductible);
  const vid = data.vehicle_id; delete data.vehicle_id;
  await api(`/vehicles/${vid}/insurance`, {method:"POST", body:JSON.stringify(data)});
  closeModal("insuranceModal");
  if(currentVehicle && currentVehicle.id===vid) viewVehicleDetails(vid);
  await loadDashboard();
  alert("Insurance saved.");
});

// Registration modal
function openRegistrationModal(vehicleId){ $("#registrationForm").reset(); $("#registrationVehicleId").value = vehicleId; openModal("registrationModal"); }
$("#registrationForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  data.fee = parseFloat(data.fee);
  const vid = data.vehicle_id; delete data.vehicle_id;
  await api(`/vehicles/${vid}/registration`, {method:"POST", body:JSON.stringify(data)});
  closeModal("registrationModal");
  if(currentVehicle && currentVehicle.id===vid) viewVehicleDetails(vid);
  await loadDashboard();
  alert("Registration saved.");
});

// All maintenance combined
async function loadAllMaintenance(){
  const vs = await api("/vehicles");
  let rows = [];
  for(const v of vs){
    const ms = await api(`/vehicles/${v.id}/maintenance`);
    ms.forEach(m=>rows.push({...m, vehicle_info:`${v.year} ${v.make} ${v.model}`}));
  }
  rows.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const el = $("#all-maintenance-records");
  if(!rows.length){ el.innerHTML = '<div class="card">No maintenance records yet.</div>'; return; }
  el.innerHTML = rows.map(r=>`
    <div class="record-item">
      <div class="record-actions">
        <button class="btn btn-warning btn-sm" onclick="editMaintenanceRecord('${r.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteMaintenanceRecord('${r.id}')">Delete</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="record-type">${r.type.replace('_',' ').toUpperCase()}</span>
        <span class="record-date">${new Date(r.date).toLocaleDateString()}</span>
      </div>
      <div><strong>${r.description}</strong> ‚Äî ${r.vehicle_info}</div>
      <div style="margin-top:6px;color:#6b7280;font-size:.95rem">
        ${r.service_provider} ‚Ä¢ ${parseInt(r.mileage).toLocaleString()} km ‚Ä¢ $${parseFloat(r.cost).toFixed(2)}
      </div>
      ${r.notes? `<div style="margin-top:6px;font-style:italic">${r.notes}</div>`:''}
      ${nextServiceBadge(r)}
    </div>
  `).join("");
}

// Dashboard tiles trigger navigation
$$("#stats-grid .stat-card").forEach(c=>c.addEventListener("click",()=>showSection(c.dataset.nav)));
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
